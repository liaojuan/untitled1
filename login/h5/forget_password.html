<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>忘记密码</title>
    <link rel="stylesheet" type="text/css" href="../css/public_title.css">
    <link rel="stylesheet" type="text/css" href="../css/public_content.css">

    <script src="../js/jquery-1.8.3.min.js"></script>
    <script src="../js/base_network_request.js"></script>
    <script src="../js/common.js"></script>

    <script>

        // 监听电话号码input里面的内容变化
        $(function(){
            $("#phone_number").bind('input porpertychange',function(){
                //获取input的值
                //1.  js原生的代码获取。可以给你的input取一个id 然后用 document.getElementById('').value;获取value值
                //2.  要使用jq  就可以给input取一个class或者id 然后用$('.class名').val()    或者$('#id名').val();获取
                var thisInput = $('#phone_number').val();
//                alert("-----------" + thisInput);
                if(thisInput.length < 11){
                    $('#get_sms_code').css('color','#ff6636').css('background', '#ffffff'); //修改button的背景色和字体的颜色
                    $('#get_sms_code').attr('disabled', true);
                    checkOnclick();
                }else if(thisInput.length == 11){
                    checkMonile(thisInput);
                }else if(thisInput.length > 11){
                    alert("手机号码不能超过11位！");
                    checkOnclick();
                    return;
                }
            });
            $('#sms_code').bind('input porpertychange',function(){
                checkOnclick();
            });
            $('#id_card_num').bind('input porpertychange',function(){
                checkOnclick();
            });
            $('#new_password').bind('input porpertychange',function(){
                checkOnclick();
            });
        });


        /**
         *  判断电话号码是否正确
         * @param str
         */
        function checkMonile(str) {
            if(str == ""){
                alert("手机号码不能为空！")
            }else{
                var rePhoneNum = /^1[3|4|5|7|8]\d{9}$/
                if (rePhoneNum.test(str)){
                    //电话号码争取
                    $('#get_sms_code').attr('disabled', false);
                    $('#get_sms_code').css('color','#ffffff').css('background', '#ff6636');
                    checkOnclick();
                }else {
                    alert("请输入正确电话号码");
                    $('#get_sms_code').attr('disabled', true);
                }
            }
        }
        /**
         *  处理密码是否可以显示
         **/
        var isShow=true;

        //点击处理 获取验证码
        $(function(){
            $("#get_sms_code").click(function () {
                var thisPhoneNum = $('#phone_number').val();
                console.log("---我是点击事件-----" + url + "---"+ thisPhoneNum);
                setCode(thisPhoneNum)
                console.log("---我是点击事件-----" + url + "---"+ thisPhoneNum + "--" + params.phone + "--" + params.type);
                submit(url, params);
            });
            $('#show_close_password').click(function () {
                var v=document.getElementById("new_password");
                var iv = document.getElementById("show_close_password");
                if (isShow) {
                    v.type="text";
                    iv.src = "../image/show_password.png";
//                    document.getElementById("show_close_password").src = "../image/look.png";
                    isShow=false;
                }else{
                    v.type="password";
                    isShow=true;
                    iv.src = "../image/look.png";
                }
            });
            $('#sure_bt').click(function () {
                sureJson($('#phone_number').val(), $('#sms_code').val(),  $('#id_card_num').val(),  $('#new_password').val());
//                sureUrl.setRequestHeader('DIBU_ACCESS_TOKEN', null).setRequestHeader('APP_VERSION', "1");
//                sureUrl.setRequestHeader("CHANNEL", "ANDROID");
//                sureUrl.setRequestHeader("CLIENT_TYPE", "driver");
                submitSureBt(sureUrl, sureParams);
            });
        });

        /**
         * 自定义参数类型，对应的是获取验证码
         **/
        var params;
        function setCode(numPhone) {
            params = {
                phone:numPhone,
                type:"DRIVER_FIND_PASSWD"
            };//创建json格式参数
        }

        //获取验证码的连接
        var url = "http://papi.dibugroup.net/vcode";
        /**
         * 获取验证码的请求 以及成功后的处理方式
         * @param url
         * @param params
         */
        //表单提交
        function submit(url,params){

            var ajaxReq = new ajaxRequest();
            ajaxReq.url = url;
            ajaxReq.dataType = "json";
            ajaxReq.data = params;
//            ajaxReq.setRequestHeader("CHANNEL", "ANDROID");
            ajaxReq.setUp();//初始化ajax

            var requst = ajaxReq.requst();

            requst.done(function(result) {//回调

//                console.log(typeof result);
//                console.log(result );

                if(result.status_code == 1){
                    console.log(result.status_code +"---" +  result.data.exprie);
                    settime(result.data.exprie);
                }else {
                    alert(result.message)
                }
            });

            requst.error(function(data){
                alert("网络异常!");
            });

        }

        /**
         * 倒计时方法
         *
         * @param countdown
         */
        function settime(countdown) {
            if (countdown == 0) {
                console.log("-----==0----" + countdown)
                $('#get_sms_code').css('color','#ffffff').css('background', '#ff6636');
                $('#get_sms_code').attr('disabled', false);
                $('#get_sms_code').text("获取验证码");
                return;
            } else {
                console.log("-----==countdown----" + countdown)
                $('#get_sms_code').css('color','#ffffff').css('background', '#ff6636');
                $('#get_sms_code').attr('disabled', true);
                $('#get_sms_code').text(countdown + "(s)");
                countdown--;
            }
            setTimeout(function() {
                settime(countdown)
            },1000)
        }
        /**
         * 判断button键是否可以点击
         */
        function checkOnclick() {
            if($('#phone_number').val().length == 11 && $('#sms_code').val().length == 6 && $('#id_card_num').val().length > 14 && $('#new_password').val().length > 5){
                $('#sure_bt').css('color','#ffffff').css('background', '#ff6636');
            }else{
                $('#sure_bt').css('color','#ffffff').css('background', '#bfbfbf');
            }
        }

        var sureUrl = "http://papi.dibugroup.net/retrieve_password"

        var sureParams;
        function sureJson(numPhone, smsCode, idCard, newPassword) {
            sureParams = {
                phone:numPhone,
                vcode:smsCode,
                id_card:idCard,
                new_password:newPassword,
            };//创建json格式参数
        }

        //表单提交
        function submitSureBt(sureUrl,sureParams){
            $.ajax({
                url : sureUrl,
                type : "post",
                data : sureParams,
                dataType : "json",
                headers: {'DIBU_ACCESS_TOKEN': 'access_token', 'APP_VERSION': 1, 'CHANNEL': 'ANDROID', 'CLIENT_TYPE': 'driver'},
                success : function(data) {
//                    console.log(data );
                    if(data != null){
                        if(data.status_code == 1) {
                            window.close();//修改成功，关闭当前窗口
                        }else {
                            alert(data.message);
                        }
                    }else{
                        alert("修改失败，请重新提交")
                    }
                },
                error : function(event, status, msg) {
                }
            });
//            Common.apiAjaxPost(sureUrl, sureParams, "post", {'DIBU_ACCESS_TOKEN': 'access_token', 'APP_VERSION': 1, 'CHANNEL': 'ANDROID', 'CLIENT_TYPE': 'driver'});

        }


    </script>
</head>
<body> <!--body 里面最好不要设置宽高，在里面添加一个div-->
<div class="on_body">
    <div style="width: 100%; height: 80px; text-align: center">
        <ul class="navItem">
            <li class="back">
                <img src="../image/left.png">
            </li>
            <li class="left_title"><label class="title_name"> 返回</label></li>
            <li class="navTitle">忘记密码</li>
        </ul>
    </div>
    <hr color="#777777"/>

    <div class="public_phone_model">
        <div class="public_line_model">
            <div class="phone_hint_text">
                <label class="public_text_style">手机号</label>
            </div>
            <div class="input_phone_num">
                <!--按道理说这个type应该设置为tel，这个是对应的电话号码-->
                <input class="public_input_style" id="phone_number" type="tel"
                       maxlength="11" placeholder="请输入手机号码"/>
                <!--oninput="OnInput (event)" onpropertychange="OnPropChanged (event)"-->
            </div>
            <div class="sms_code_bt">
                <button class="public_sms_code_bt" id="get_sms_code" disabled="disabled">获取验证码</button>
            </div>
        </div>

        <hr color="#e8e8e8" style="margin-left: 25px;"/>

        <div class="public_line_model">
            <div class="phone_hint_text">
                <label class="public_text_style">验证码</label>
            </div>
            <div class="base_input_style">
                <input class="public_input_style" id="sms_code" type="phone_number" maxlength="6" placeholder="请输入短信验证码"/>
            </div>
        </div>

        <hr color="#e8e8e8" style="margin-left: 25px; height: 1px"/>

        <div class="public_line_model">
            <div class="phone_hint_text">
                <label class="public_text_style">身份证号</label>
            </div>
            <div class="base_input_style">
                <input class="public_input_style" id="id_card_num" type="text" maxlength="18" placeholder="请输入身份证号"/>
            </div>
        </div>

        <hr color="#e8e8e8" style="margin-left: 25px; height: 1px"/>

        <div class="public_line_model">
            <div class="phone_hint_text">
                <label class="public_text_style">设置新密码</label>
            </div>
            <div class="base_img_style">
                <input class="public_input_style" id="new_password" type="password" maxlength="12" placeholder="请输入新密码"/>
            </div>
            <img style="margin-top: 30px; margin-left: 30px; " src="../image/look.png" id="show_close_password">
        </div>

    </div>

    <button class="base_button" id="sure_bt">确认重置</button>
</div>
</body>

<script></script>
</html>